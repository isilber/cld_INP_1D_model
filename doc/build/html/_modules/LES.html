


<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LES &#8212; LES-Informed Ice Formation Evaluation Column Model (LIIFE-CM)  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/cloud.css" />
    <link rel="stylesheet" type="text/css" href="../_static/gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/gallery-rendered-html.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text:400,i,b,bi|Open+Sans:400,i,b,bi|Roboto+Mono:400,i,b,bi&amp;display=swap" type="text/css" />
    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>

    
    
     
        <script src="../_static/jquery.cookie.js"></script>
    

    
     
        <script src="../_static/cloud.base.js"></script>
    

    
     
        <script src="../_static/cloud.js"></script>
    

    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">LES-Informed Ice Formation Evaluation Column Model (LIIFE-CM)  documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">LES</a></li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for LES</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module includes the LES class and the DHARMA sub-class</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<div class="viewcode-block" id="LES"><a class="viewcode-back" href="../API/LES.html#LES.LES">[docs]</a><span class="k">class</span> <span class="nc">LES</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Model namelists and unit conversion coefficient required for the 1D model.</span>
<span class="sd">    The LES class includes methods to processes model output and prepare the out fields for the 1D model.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    Ni_field: dict</span>
<span class="sd">       Ice number concentration fieldname and scaling factor required for L^-1 units</span>
<span class="sd">    pflux_field: dict</span>
<span class="sd">        Precipitation flux fieldname and scaling factor for mm/h.</span>
<span class="sd">    T_field: dict</span>
<span class="sd">        Temperature field name and addition factor in case of T reported in C (K is needed).</span>
<span class="sd">    q_liq_field: dict</span>
<span class="sd">        Liquid mixing ratio fieldname and scaling factor for g/kg.</span>
<span class="sd">    RH_field: dict</span>
<span class="sd">        RH fieldname and scaling factor for fraction units (not %).</span>
<span class="sd">    model_name: str</span>
<span class="sd">        name of model.</span>
<span class="sd">    time_dim: str</span>
<span class="sd">        name of the time dimension.</span>
<span class="sd">    height_dim: str</span>
<span class="sd">        name of the height dim.</span>
<span class="sd">    height_dim_2nd: str</span>
<span class="sd">        name of the height dim for grid cell edge coordinates.</span>
<span class="sd">    q_liq_pbl_cut: float</span>
<span class="sd">        value of q_liq cut (g/kg) required to define the PBL top z-index (where LWC becomes negligible) -</span>
<span class="sd">        to be used in &#39;_crop_fields&#39; if &#39;height_ind_2crop&#39; == &#39;ql_pbl&#39;.</span>
<span class="sd">    q_liq_cbh: float</span>
<span class="sd">        Threshold value (g/kg) for cloud base height defined using q_liq.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_liq_pbl_cut</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ni_field</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;scaling&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>  <span class="c1"># scale to L^-1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pflux_field</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;scaling&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>  <span class="c1"># scale to mm/h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_field</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;addition&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>  <span class="c1"># scale to K</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_liq_field</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;scaling&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>  <span class="c1"># scale to g/kg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RH_field</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;scaling&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>  <span class="c1"># scale to fraction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_dim</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># assuming in seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height_dim</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># assuming in m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height_dim_2nd</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># assuming in m</span>
        <span class="k">if</span> <span class="n">q_liq_pbl_cut</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q_liq_pbl_cut</span> <span class="o">=</span> <span class="mf">1e-3</span>  <span class="c1"># g/kg (default value of 1e-3).</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q_liq_pbl_cut</span> <span class="o">=</span> <span class="n">q_liq_pbl_cut</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_liq_cbh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_liq_pbl_cut</span>  <span class="c1"># Equal to the pbl cutoff value by default</span>

    <span class="k">def</span> <span class="nf">_crop_time_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_harvest</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Crop model output time range.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        t_harvest: scalar, 2-element tuple, list (or ndarray), or None</span>
<span class="sd">            If scalar then using the nearest time (assuming units of seconds) to initialize the model</span>
<span class="sd">            (single profile).</span>
<span class="sd">            If a tuple, cropping the range defined by the first two elements (increasing values) using a</span>
<span class="sd">            slice object.</span>
<span class="sd">            If a list, cropping the times specified in the list (can be used take LES output profiles every</span>
<span class="sd">            delta_t seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t_harvest</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">time_dim</span><span class="p">:</span> <span class="p">[</span><span class="n">t_harvest</span><span class="p">]},</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t_harvest</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>  <span class="c1"># assuming a 2-element tuple.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_harvest</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;t_harvest (time range) tuple length should be 2&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">time_dim</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="n">t_harvest</span><span class="p">)})</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t_harvest</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">time_dim</span><span class="p">:</span> <span class="n">t_harvest</span><span class="p">},</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_crop_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields_to_retain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">height_ind_2crop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Crop the required fields (and other requested fields), with the option of cropping the</span>
<span class="sd">        height dim using specified indices.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fields_to_retain: list or None</span>
<span class="sd">            Fieldnames to crop from the LES output (required to properly run the model).</span>
<span class="sd">            If None, then cropping the minimum number of required fields using the model&#39;s namelist convention</span>
<span class="sd">            (Temperature, q_liq, RH, precipitation flux, and ice number concentration).</span>
<span class="sd">        height_ind_2crop: list, np.ndarray, float, int, str, or None</span>
<span class="sd">            Indices of heights (in a list or np.ndarray) to crop from the model output (e.g., up to the PBL top).</span>
<span class="sd">            if float then indicating then the value indicates the cropped domain-top height.</span>
<span class="sd">            if int then indicating the index of the domain-top height.</span>
<span class="sd">            if str then different defitions for PBL:</span>
<span class="sd">                - if == &quot;ql_pbl&quot; then cropping all values within the PBL defined here based on the</span>
<span class="sd">                &#39;q_liq_pbl_cut&#39; attribute. If more than a single time step exist in the dataset, then cropping</span>
<span class="sd">                the highest index corresponding to the cutoff.</span>
<span class="sd">                - OTHER OPTIONS TO BE ADDED.</span>
<span class="sd">            If None then not cropping.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fields_to_retain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fields_to_retain</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Ni_field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pflux_field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">q_liq_field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">RH_field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span>

        <span class="c1"># crop variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">fields_to_retain</span><span class="p">]</span>  <span class="c1"># retain variables needed.</span>

        <span class="c1"># crop heights</span>
        <span class="k">if</span> <span class="n">height_ind_2crop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">height_ind_2crop</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">height_ind_2crop</span> <span class="o">==</span> <span class="s2">&quot;ql_pbl&quot;</span><span class="p">:</span>  <span class="c1"># 1D model domain extends only to PBL top</span>
                    <span class="n">rel_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">q_liq_field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_liq_pbl_cut</span> <span class="o">/</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">q_liq_field</span><span class="p">[</span><span class="s2">&quot;scaling&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown croppoing method string - skipping xr dataset (LES domain) cropping.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">height_ind_2crop</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">rel_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">height_ind_2crop</span> <span class="o">-</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">height_dim</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">height_ind_2crop</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">rel_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">height_ind_2crop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">height_ind_2crop</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="n">rel_inds</span> <span class="o">=</span> <span class="n">height_ind_2crop</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[{</span><span class="bp">self</span><span class="o">.</span><span class="n">height_dim</span><span class="p">:</span> <span class="n">rel_inds</span><span class="p">}]</span>

    <span class="k">def</span> <span class="nf">_prepare_les_dataset_for_1d_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbh_det_method</span><span class="o">=</span><span class="s2">&quot;ql_cbh&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        scale (unit conversion), rename the required fields (prepare the dataset for informing the 1D model</span>
<span class="sd">        allowing retaining only the les xr dataset instead of the full LES class), and calculate some additional.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cbh_det_method: str</span>
<span class="sd">            Method to determine cloud base with:</span>
<span class="sd">                - if == &quot;ql_cbh&quot; then cbh is determined by a q_liq threshold set with the &#39;q_liq_cbh&#39; attribute.</span>
<span class="sd">                - OTHER OPTIONS TO BE ADDED.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">height_dim</span><span class="p">:</span> <span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_dim</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">pflux_field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="s2">&quot;prec&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ni_field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="s2">&quot;Ni&quot;</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">T_field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_liq_field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="s2">&quot;ql&quot;</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">RH_field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="s2">&quot;RH&quot;</span><span class="p">})</span>

        <span class="c1"># scale and convert to float64</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;float32&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;RH&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RH_field</span><span class="p">[</span><span class="s2">&quot;scaling&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ql&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_liq_field</span><span class="p">[</span><span class="s2">&quot;scaling&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_field</span><span class="p">[</span><span class="s2">&quot;addition&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;Ni&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ni_field</span><span class="p">[</span><span class="s2">&quot;scaling&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;prec&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pflux_field</span><span class="p">[</span><span class="s2">&quot;scaling&quot;</span><span class="p">]</span>

        <span class="c1"># set units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$m$&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$s$&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;RH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ql&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$g\:kg^{-1}$&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$K$&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;Ni&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;$L^{-1}$&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;prec&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$mm\:h^{-1}$&quot;</span>

        <span class="c1"># calculate ∆aw field for ABIFM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calc_delta_aw</span><span class="p">()</span>

        <span class="c1"># calculated weighted precip rates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_find_and_calc_cb_precip</span><span class="p">(</span><span class="n">cbh_det_method</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_find_and_calc_cb_precip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cbh_det_method</span><span class="o">=</span><span class="s2">&quot;ql_cbh&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        calculate number-weighted precip rate in the domain and allocate a field for values at lowest cloud base.</span>
<span class="sd">        The method finds cbh as well as cth</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cbh_det_method: str</span>
<span class="sd">            Method to determine cloud base with:</span>
<span class="sd">                - if == &quot;ql_cbh&quot; then cbh is determined by a q_liq threshold set with the &#39;q_liq_cbh&#39; attribute.</span>
<span class="sd">                - OTHER OPTIONS TO BE ADDED.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;P_Ni&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;prec&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;Ni&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;P_Ni&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$mm\:h^{-1}\:L^{-1}$&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;P_Ni&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ni-normalized precipitation rate&quot;</span>

        <span class="c1"># find all cloud bases and the precip rate in the lowest cloud base in every time step (each profile).</span>
        <span class="k">if</span> <span class="n">cbh_det_method</span> <span class="o">==</span> <span class="s2">&quot;ql_cbh&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;cbh_all&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ql&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_liq_cbh</span><span class="p">,</span> <span class="n">prepend</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                      <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;P_Ni&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;cth_all&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ql&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_liq_cbh</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                      <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;P_Ni&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown cbh method string - skipping cbh detection function&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;cbh_all&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;All detected cloud base heights (receive a &#39;True&#39; value)&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;cbh_all&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;All detected cloud top heights (receive a &#39;True&#39; value)&quot;</span>

        <span class="n">cbh_lowest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;cbh_all&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;cbh_all&quot;</span><span class="p">]))</span>
        <span class="n">cth_lowest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;cth_all&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;cth_all&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;lowest_cbh&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;lowest_cbh&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;$m$&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;lowest_cth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;lowest_cbh&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;lowest_cbh&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Lowest cloud base height per profile&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;lowest_cth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Lowest cloud top height per profile&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;lowest_cbh&quot;</span><span class="p">][</span><span class="n">cbh_lowest</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">cbh_lowest</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;lowest_cth&quot;</span><span class="p">][</span><span class="n">cth_lowest</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">cth_lowest</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;Pcb_per_Ni&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;Pcb_per_Ni&quot;</span><span class="p">][</span><span class="n">cbh_lowest</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;P_Ni&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">cbh_lowest</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;Pcb_per_Ni&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$mm\:h^{-1}r\:L^{-1}$&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;Pcb_per_Ni&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ni-normalized lowest cloud base precipitation rate&quot;</span>

    <span class="k">def</span> <span class="nf">_calc_delta_aw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        calculate the ∆aw field for ABIFM</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;delta_aw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;RH&#39;</span><span class="p">]</span> <span class="o">-</span> \
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">9.550426</span> <span class="o">-</span> <span class="mf">5723.265</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">3.53068</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mf">0.00728332</span> <span class="o">*</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">54.842763</span> <span class="o">-</span> <span class="mf">6763.22</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">-</span>
                                     <span class="mf">4.210</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.000367</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">+</span>
                                     <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="mf">0.0415</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">218.8</span><span class="p">))</span> <span class="o">*</span>
                                     <span class="p">(</span><span class="mf">53.878</span> <span class="o">-</span> <span class="mf">1331.22</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">9.44523</span> <span class="o">*</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mf">0.014025</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]))))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;delta_aw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span></div>


<div class="viewcode-block" id="DHARMA"><a class="viewcode-back" href="../API/LES.html#LES.DHARMA">[docs]</a><span class="k">class</span> <span class="nc">DHARMA</span><span class="p">(</span><span class="n">LES</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">les_out_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">les_out_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_harvest</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fields_to_retain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">height_ind_2crop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbh_det_method</span><span class="o">=</span><span class="s2">&quot;ql_cbh&quot;</span><span class="p">,</span> <span class="n">q_liq_pbl_cut</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        LES class for DHARMA that loads model output dataset</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        les_out_path: str or None</span>
<span class="sd">            LES output path (can be relative to running directory). Use default if None.</span>
<span class="sd">        les_out_filename: str or None</span>
<span class="sd">            LES output filename. Use default file if None.</span>
<span class="sd">        t_harvest: scalar, 2-element tuple, list (or ndarray), or None</span>
<span class="sd">            If scalar then using the nearest time (assuming units of seconds) to initialize the model</span>
<span class="sd">            (single profile).</span>
<span class="sd">            If a tuple, cropping the range defined by the first two elements (increasing values) using a</span>
<span class="sd">            slice object.</span>
<span class="sd">            If a list, cropping the times specified in the list (can be used take LES output profiles every</span>
<span class="sd">            delta_t seconds.</span>
<span class="sd">        fields_to_retain: list or None</span>
<span class="sd">            Fieldnames to crop from the LES output (required to properly run the model).</span>
<span class="sd">            If None, then cropping the minimum number of required fields using DHARMA&#39;s namelist convention</span>
<span class="sd">            (Temperature [K], q_liq [kg/kg], RH [fraction], precipitation flux [mm/h], and ice number</span>
<span class="sd">            concentration [cm^-3]).</span>
<span class="sd">        height_ind_2crop: list, str, or None</span>
<span class="sd">            Indices of heights to crop from the model output (e.g., up to the PBL top).</span>
<span class="sd">            if str then different definitions for PBL:</span>
<span class="sd">                - if == &quot;ql_pbl&quot; then cropping all values within the PBL defined here based on the &#39;q_liq_pbl_cut&#39;</span>
<span class="sd">                  attribute. If more than a single time step exist in the dataset, then cropping</span>
<span class="sd">                  the highest index corresponding to the cutoff.</span>
<span class="sd">                - OTHER OPTIONS TO BE ADDED.</span>
<span class="sd">            If None then not cropping.</span>
<span class="sd">        cbh_det_method: str</span>
<span class="sd">            Method to determine cloud base with:</span>
<span class="sd">                - if == &quot;ql_cbh&quot; then cbh is determined by a q_liq threshold set with the &#39;q_liq_cbh&#39; attribute.</span>
<span class="sd">                - OTHER OPTIONS TO BE ADDED.</span>
<span class="sd">        q_liq_pbl_cutoff: float</span>
<span class="sd">            value of q_liq_cut (g/kg) required to define the PBL top z-index (where LWC becomes negligible) -</span>
<span class="sd">            to be used in &#39;_crop_fields&#39; if &#39;height_ind_2crop&#39; == &#39;ql_pbl&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">q_liq_pbl_cut</span><span class="o">=</span><span class="n">q_liq_pbl_cut</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ni_field</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ntot_3&quot;</span><span class="p">,</span> <span class="s2">&quot;scaling&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}</span>  <span class="c1"># scale to L^-1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pflux_field</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;pflux_3&quot;</span><span class="p">,</span> <span class="s2">&quot;scaling&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>  <span class="c1"># scale to mm/h</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_field</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;addition&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>  <span class="c1"># scale to K (addition)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_liq_field</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ql&quot;</span><span class="p">,</span> <span class="s2">&quot;scaling&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}</span>  <span class="c1"># scale to g/kg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RH_field</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;RH&quot;</span><span class="p">,</span> <span class="s2">&quot;scaling&quot;</span><span class="p">:</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mf">100.</span><span class="p">}</span>  <span class="c1"># scale to fraction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;DHARMA&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_dim</span> <span class="o">=</span> <span class="s2">&quot;time&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height_dim</span> <span class="o">=</span> <span class="s2">&quot;zt&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height_dim_2nd</span> <span class="o">=</span> <span class="s2">&quot;zw&quot;</span>

        <span class="c1"># using the default ISDAC model output if None.</span>
        <span class="k">if</span> <span class="n">les_out_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">les_out_path</span> <span class="o">=</span> <span class="s1">&#39;data_les/shi3_isdac_sfc6_pTqv_fthqv_lw_3_abifm_final/&#39;</span>
        <span class="k">if</span> <span class="n">les_out_filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">les_out_filename</span> <span class="o">=</span> <span class="s1">&#39;dharma.soundings.cdf&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">les_out_path</span> <span class="o">=</span> <span class="n">les_out_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">les_out_filename</span> <span class="o">=</span> <span class="n">les_out_filename</span>

        <span class="c1"># load model output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">les_out_path</span> <span class="o">+</span> <span class="n">les_out_filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height_dim_2nd</span><span class="p">))</span>  <span class="c1"># validate dim order</span>

        <span class="c1"># crop specific model output time range (if requested)</span>
        <span class="k">if</span> <span class="n">t_harvest</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_crop_time_range</span><span class="p">(</span><span class="n">t_harvest</span><span class="p">)</span>

        <span class="c1"># crop specific model output fields and height range</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_crop_fields</span><span class="p">(</span><span class="n">fields_to_retain</span><span class="o">=</span><span class="n">fields_to_retain</span><span class="p">,</span> <span class="n">height_ind_2crop</span><span class="o">=</span><span class="n">height_ind_2crop</span><span class="p">)</span>

        <span class="c1"># prepare fieldnames and generate new ones required for the 1D model</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_prepare_les_dataset_for_1d_model</span><span class="p">(</span><span class="n">cbh_det_method</span><span class="o">=</span><span class="n">cbh_det_method</span><span class="p">)</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../index.html">LES-Informed Ice Formation Evaluation Column Model (LIIFE-CM)  documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">LES</a></li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, Israel Silber, Ann Fridlind.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.0.1.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>